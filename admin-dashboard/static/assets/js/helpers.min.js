function showPolicyModal(){if(!(localStorage.getItem("agreed")==="true")){$("#policy-modal").modal({backdrop:"static",keyboard:false})}}function acceptPolicy(){console.log("Policy agreed... caching");localStorage.setItem("agreed","true");$("#policy-modal").modal("hide")}function getCurrentUserRoles(callback){let cachedRoles=localStorage.getItem("current-user-roles");if(cachedRoles){console.log("Using cache to get roles from LS...");callback(JSON.parse(cachedRoles))}else{$.get("/user/current-user-roles",function(){console.log("Got Current User Roles")},"json").done(function(data){let roles=data.roles.filter(function(elem){return elem.endsWith("-admin")});localStorage.setItem("current-user-roles",JSON.stringify(roles));callback(roles)}).fail(requestFailure)}}function showSwitchRoleModal(){$("#switch-campus").modal("show");$("#user-roles").html("<option disabled selected>Loading...</option>");let currentRole=getCookie("assume_role");getCurrentUserRoles(function(roles){let options=[];roles.forEach(function(e){if(e.endsWith("-admin")){options.push(`<option value="${e}"`+(currentRole===e?"selected":"")+`>${e.split("-admin")[0]}</option>`)}});$("#user-roles").html(options.join(""))})}function submitSwitchCampus(){$("#switch-campus-btn").prop("disabled",true).html("Switching...");let userRole=$("#user-roles").val();if(userRole==="Loading..."){alert("Please wait for the system to load your roles")}$.get("/user/assume-role/"+userRole,function(){console.log("Received Assume Role Cookie")},"json").done(async function(data){let submitBtn=$("#switch-campus-btn");submitBtn.html("Success.");await sleep(1500);window.location.href="/"}).fail(requestFailure)}function showResendBriefingModal(){$("#resend-briefing-text").innerHTML="Loading...";$.get("/api/briefing-enabled",function(){console.log("Got briefing status for current school");$("#resend-briefing-text").innerHTML="Resend Daily Briefing"},"json").done(function(data){if(data.enabled){console.log("Briefings are enabled... showing");$("#digest-modal").modal("show")}else{console.log("Briefings are disabled... hiding");alert("Daily Digests are not enabled for your school. Please contact an administrator to set them up.")}}).fail(requestFailure)}async function submitResendBriefingForm(){$("#resendButton").html("Submitting...").prop("disabled",true);$.post("/health/send-targeted-digest",JSON.stringify({}),function(){console.log("Send targeted digest report recieved")},"json").done(async function(data){$("#resendButton").html("Success!");await sleep(500);$("#resendButton").html("Resend").prop("disabled",false);$("#digest-modal").modal("hide")}).fail(requestFailure)}var delete_cookie=function(name){document.cookie=name+"=;expires=Thu, 01 Jan 1970 00:00:01 GMT;"};function logoutUser(){delete_cookie("assume_role");localStorage.clear();window.location.href="/admin/oauth/logout"}function requestFailure(data){alert("[Error] Failed to communicate with backend services: "+JSON.stringify(data));console.log("Error while issuing request");console.log(data)}function downloadTableAsCSV(table_id,separator=","){var rows=document.querySelectorAll("table#"+table_id+" tr");var csv=[];for(var i=0;i<rows.length;i++){var row=[],cols=rows[i].querySelectorAll("td, th");for(var j=0;j<cols.length;j++){var data=cols[j].innerText.replace(/(\r\n|\n|\r)/gm,"").replace(/(\s\s)/gm," ");data=data.replace(/"/g,'""');row.push('"'+data+'"')}csv.push(row.join(separator))}var csv_string=csv.join("\n");var filename="export_"+table_id+"_"+(new Date).toLocaleDateString()+".csv";var link=document.createElement("a");link.style.display="none";link.setAttribute("target","_blank");link.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(csv_string));link.setAttribute("download",filename);document.body.appendChild(link);link.click();document.body.removeChild(link)}$.delete=function(url,data,callback,type){if($.isFunction(data)){type=type||callback,callback=data,data={}}return $.ajax({url:url,type:"DELETE",success:callback,data:data,contentType:type})};function truncate(str,n){return str.length>n?str.substr(0,n-1)+"&hellip;":str}function getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2)return parts.pop().split(";").shift()}async function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms))}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};String.prototype.escapeQuotes=function(){return this.replace("'","&#39;").replace('"',"&quot;")};String.prototype.renderQuotes=function(){return this.replace("&#39;","'").replace("&quote;",'"')};$(document).ready(function(){showPolicyModal()});