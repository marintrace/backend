const homeUserStatusPagLimit=200;let homeUserStatusPagToken=0;let selectedMember=null;$.ajaxSetup({headers:{"Content-Type":"application/json",Accept:"application/json"}});function populateHealthSummaryTable(email=null,getall=false){let data={pagination_token:homeUserStatusPagToken,limit:getall?1e4:homeUserStatusPagLimit};if(email!=null){data["email"]=email.escapeQuotes()}$.post("/api/paginate-user-summary-items",JSON.stringify(data),function(){console.log("Update home status summaries request response received")},"json").done(function(data){if(data["statuses"].length===0&&!getall){alert("No more data!");return}homeUserStatusPagToken=data["pagination_token"];data["statuses"].forEach(function(e){let escapedEmail=e.email.escapeQuotes();let rows=[`<input type="radio" data-email="${escapedEmail}" onchange="itemSelectionChange(this)" name="userSelect" `+(selectedMember===escapedEmail?"checked":"")+" class='big-select'/>",`<a href='/detail/${escapedEmail}'>${escapedEmail}</a>`+(e.status!=="active"?" ("+e.status.replace("_","-")+")":""),"<span class='badge badge-dot mr-4'><i class='bg-"+e.health.color+"'></i><span class='status'>"+`<a class='modal-link' onclick='showHealthChangeModal("${escapedEmail}")'>`+truncate(e.health.criteria.join(" & "),45)+" </a></span></span>","<span class='badge badge-dot mr-4'><i class='bg-"+e.location.color+"'></i><span class='status'>"+`<a class='modal-link' onclick='showLocationChangeModal("${escapedEmail}")'>`+e.location.location.capitalize()+"</a></span></span>"];$("#summaries").append("<tr><td>"+rows.join("</td><td>")+"</td>")})}).fail(requestFailure)}function itemSelectionChange(radio){let email=radio.dataset.email;selectedMember=email;$("#health-button-1").html("Modify Health").attr("onclick",`showHealthChangeModal('${email}')`);$("#health-button-2").html("Change Location").attr("onclick",`showLocationChangeModal('${email}')`);$("#clear-toggle").html("<br><button class='btn btn-secondary' onclick='clearHealthSelection()'>Clear Selection</button>")}function clearHealthSelection(){$("#health-button-1").html("Export to CSV").attr("onclick","exportHealthSummariesAsCSV()");$("#health-button-2").html("Manage Members").attr("onclick","goToManageUsers()");$("#clear-toggle").html("");document.getElementsByName("userSelect").forEach(function(e){e.checked=false});selectedMember=null}async function exportHealthSummariesAsCSV(){$("#csv-export-home").html("Loading...").prop("disabled",true);populateHealthSummaryTable(null,true);await sleep(5e3);downloadTableAsCSV("home-status-summaries");$("#csv-export-home").html("Export to CSV").prop("disabled",false)}function showHealthChangeModal(email){$("#health-user-email").html(email.escapeQuotes());$("#submitHealthModification").attr("onclick",`submitHealthReportForm("${email.escapeQuotes()}", false)`);$("#setHealthy").attr("onclick",`submitHealthReportForm("${email.escapeQuotes()}", true)`);$("#toggleVaccine").attr("onclick",`showVaccinationOptionModal("${email.escapeQuotes()}")`);$("#health-change").modal("show")}function showVaccinationOptionModal(email){$("#health-change").modal("hide");$("#vac-user-email").html(email.escapeQuotes());$("#submitVaccineToggle").attr("onclick",`submitVaccineOptionForm("${email.escapeQuotes()}")`);$("#vaccine-options").modal("show")}async function submitVaccineOptionForm(email){const vax_status=$("input[name='vax-status']:checked").val();if(vax_status==null){alert("You must select an option to submit!");return}$("#submitVaccineToggle").prop("disabled",true);let data={status:vax_status,email:email.renderQuotes()};$.post("/health/modify-vaccination",JSON.stringify(data),function(){console.log("Vaccination change completed")},"json").done(async function(data){$("#submitVaccineToggle").html("Success");await sleep(500);$("#vaccine-options").modal("hide");$("#submitVaccineToggle").prop("disabled",false);$("#submitVaccineToggle").html("Submit");window.location.reload()}).fail(requestFailure)}function showLocationChangeModal(email){$("#loc-user-email").html(email.escapeQuotes());$("#submitLocationChange").attr("onclick",`submitLocationChangeForm("${email.escapeQuotes()}")`);$("#location-change").modal("show")}async function submitHealthReportForm(email,set_healthy){let payload={};if(!set_healthy){const num_symptoms=$("#num_symptoms").val();const commercial=$("input[name='commercial']:checked").val();const proximity=$("input[name='proximity']:checked").val();if(num_symptoms==null||commercial==null||proximity==null){alert("You must complete all options to submit!");return}let parsed_num_symptoms=parseInt(num_symptoms);if(parsed_num_symptoms<0||parsed_num_symptoms>12){alert("Number of symptoms must be greater than 0 and less than 12");return}payload={num_symptoms:parsed_num_symptoms,commercial_flight:JSON.parse(commercial.toLowerCase()),proximity:JSON.parse(proximity.toLowerCase())}}else{payload={num_symptoms:0,commercial_flight:false,proximity:false}}payload["email"]=email.renderQuotes();$("#submitHealthModification").prop("disabled",true);$("#setHealthy").prop("disabled",true);$.post("/health/modify-health",JSON.stringify(payload),function(){console.log("Modify health completed")},"json").done(async function(data){$("#submitHealthModification").html("Success");await sleep(500);$("#health-change").modal("hide");$("#submitHealthModification").prop("disabled",false);$("#setHealthy").prop("disabled",false);$("#submitHealthModification").html("submit");window.location.reload()}).fail(requestFailure)}async function submitLocationChangeForm(email){const location=$("input[name='location']:checked").val();if(location==null){alert("You must select an option to submit!");return}$("#submitLocationChange").prop("disabled",true);let data={location:location,email:email.renderQuotes()};$.post("/health/queue-location-change",JSON.stringify(data),function(){console.log("Location change completed")},"json").done(async function(data){$("#submitLocationChange").html("Success");await sleep(500);$("#location-change").modal("hide");$("#submitLocationChange").prop("disabled",false);$("#submitLocationChange").html("Submit");window.location.reload()}).fail(requestFailure)}function submitHealthSearch(){homeUserStatusPagToken=0;const email=$("#email-input").val();$("#summaries").html("");populateHealthSummaryTable(email);$("#load-more-home").attr("onclick",`populateHealthSummaryTable("${email.escapeQuotes()}")`);$("#clear-toggle").html("<br><button class='btn btn-secondary' onclick='clearHealthSearch()'>Clear Search</button>")}function clearHealthSearch(){homeUserStatusPagToken=0;$("#email-input").val("");$("#summaries").html("");populateHealthSummaryTable();$("#clear-toggle").html("");$("#load-more-home").attr("onclick","populateHealthSummaryTable()")}function goToManageUsers(){window.location="/manage-users"}function updateSubmittedReportsWidget(){$.post("/api/submitted-symptom-reports",JSON.stringify({}),function(){console.log("Update submitted symptom reports received")},"json").done(function(data){$("#submitted-symptom-reports").html(data.value)}).fail(requestFailure)}