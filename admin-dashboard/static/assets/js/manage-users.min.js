const communityUserPagLimit=300;let communityUserPagToken=0;let selectedCommunityUsers=new Set;function populateMembersTable(email=null,getall=true){let data={pagination_token:communityUserPagToken,limit:getall?1e4:communityUserPagLimit};if(email!=null){data["email"]=email.escapeQuotes()}$.post("/user/paginate-users",JSON.stringify(data),function(){console.log("Get community members request received...")},"json").done(function(data){if(data["users"].length===0){$("#home-footer").hide();return}communityUserPagToken=data["pagination_token"];data["users"].forEach(function(e){let escapedEmail=e.email.escapeQuotes();let rows=[`<input type='checkbox' onchange='userSelectionChange(this)' name="${escapedEmail}" 
                class="member-edit-checkbox big-select" `+(selectedCommunityUsers.has(escapedEmail)?"checked":"")+"/>",e.name+(e.active?"":" (invited)"),`<a href='/detail/${escapedEmail}'>${escapedEmail}</a>`,"<span class='badge badge-dot mr-4'><i class='bg-"+(e.blocked?"danger":"success")+"'></i>"+"<span>"+(e.blocked?"Disabled":"Enabled")+"</span>"];$("#users").append("<tr><td>"+rows.join("</td><td>")+"</td>")})}).fail(requestFailure)}function userSelectionChange(checkbox){if(checkbox.checked){selectedCommunityUsers.add(checkbox.name.renderQuotes())}else{selectedCommunityUsers.delete(checkbox.name.renderQuotes())}if(selectedCommunityUsers.size===0){deselectAllUsers()}else{$("#user-button-1").html(`Deselect ${selectedCommunityUsers.size} users`).attr("onclick","deselectAllUsers()");$("#user-button-2").html(`Modify ${selectedCommunityUsers.size} users`).attr("onclick","showModifyModal()")}}function showModifyModal(){$("#modify-users").modal("show");$.get("/user/current-user-roles",function(){console.log("Got Current User Roles")},"json").done(function(data){if(data.roles.length>1){$("#switch-report").show();$("#campus-history-warning").show();$("#delete-campus-history-btn").show()}}).fail(requestFailure)}function deselectAllUsers(){$(":checkbox").each(function(){this.checked=false});$("#user-button-1").html("Import from CSV").attr("onclick","showUserImportModal()");$("#user-button-2").html("Invite User").attr("onclick","showUserInviteModal()");selectedCommunityUsers.clear()}function updateInviteStatsWidget(){$.get("/user/get-invite-stats",function(){console.log("Received Invite Stats")},"json").done(function(data){$("#active-members").html(data.active);$("#inactive-members").html(data.inactive)}).fail(requestFailure)}function submitMemberSearch(){communityUserPagToken=0;const email=$("#email-input").val();$("#users").html("");populateMembersTable(email);$("#load-more-users").attr("onclick",`populateMembersTable("${email.escapeQuotes()}")`);$("#search-toggle").html("<br><button class='btn btn-secondary' onclick='clearMemberSearch()'>Clear Search</button>")}function clearMemberSearch(){communityUserPagToken=0;$("#email-input").val("");$("#users").html("");populateMembersTable();$("#search-toggle").html("");$("#load-more-home").attr("onclick","populateMembersTable()")}function showUserImportModal(){$("#user-import").modal("show")}function showUserInviteModal(){$("#invite-user").modal("show")}async function initiateBulkImport(){$("#import-submit").html("Processing...").prop("disabled",true);let formData=new FormData(document.getElementById("bulk-import"));formData.append("users",$("input[type=file]")[0].files[0]);$.ajax({url:"/user/bulk-import-users",type:"POST",data:formData,contentType:false,processData:false,success:async function(){await sleep(3e3);$("#import-submit").html("Success");await sleep(500);$("#user-import").modal("hide");$("#import-submit").html("Submit");window.location.reload()}})}function submitInviteUser(){const email=$("#user_email").val();const first_name=$("#user_first_name").val();const last_name=$("#user_last_name").val();const vaccinated=$("input[name='vaccinated']:checked").val();const location=$("input[name='location']:checked").val();if(email==null||first_name==null||last_name==null||vaccinated==null||location==null){alert("You must fill in all fields in the form to submit!");return}let payload={email:email,first_name:first_name,last_name:last_name,vaccinated:JSON.parse(vaccinated.toLowerCase())?"vaccinated":"not_vaccinated",location:location};$("#submitInviteUser").prop("disabled",true).html("Processing...");$.post("/user/create-user",JSON.stringify(payload),function(){console.log("Submit Invite User Completed!")},"json").done(async function(data){let submitBtn=$("#submitInviteUser");submitBtn.html("Success.");await sleep(1500);$("#invite-user").modal("hide");submitBtn.prop("disabled",false);window.location.reload()}).fail(requestFailure)}function confirmUserConsent(operation,callback){let userItems="";selectedCommunityUsers.forEach(function(email){userItems+="<li>"+email.escapeQuotes()+"</li>"});let body=`<p>Are you sure you want to ${operation} ${selectedCommunityUsers.size} users? 
                The following users will be affected:</p><br><ul>${userItems}</ul>`;$("#confirm-title").html("Are you sure?");$("#confirm-body").html(body);$("#confirm-modal").modal("show");$("#confirm-agree").on("click",function(){$("#confirm-modal").modal("hide");callback()});$("#confirm-reject").on("click",function(){$("#confirm-modal").modal("hide");$("#modify-users").modal("hide")})}function submitCheckedToggleAccess(disable=true){confirmUserConsent(disable?"disable":"enable",function(){$(".btn-reduced").prop("disabled",true);let selectedButton=$(disable?"#disable-access-btn":"#enable-access-btn");selectedButton.html("Processing...");let users=[];selectedCommunityUsers.forEach(function(email){users.push({email:email,block:disable})});$.post("/user/toggle-access",JSON.stringify({users:users}),function(){console.log("Toggle Access User Complete")},"json").done(async function(data){selectedButton.html("Success.");await sleep(1e3);$("#modify-users").modal("hide");$(".btn-reduced").prop("disabled",false);window.location.reload()}).fail(requestFailure)})}function submitCheckedPasswordReset(){confirmUserConsent("re-invite",function(){$(".btn-reduced").prop("disabled",true);let selectedButton=$("#password-reset-btn");selectedButton.html("Processing...");let identifiers=[];selectedCommunityUsers.forEach(function(email){identifiers.push({email:email})});$.post("/user/password-reset",JSON.stringify({identifiers:identifiers}),function(){console.log("Password Reset Complete.")},"json").done(async function(data){selectedButton.html("Success.");await sleep(1e3);$("#modify-users").modal("hide");$(".btn-reduced").prop("disabled",false);window.location.reload()})})}function showSwitchReportNodeModal(){}function submitCheckedDeleteUsers(){confirmUserConsent("delete",function(){$(".btn-reduced").prop("disabled",true);let selectedButton=$("#delete-users-btn");selectedButton.html("Processing...");let identifiers=[];selectedCommunityUsers.forEach(function(email){identifiers.push({email:email})});$.delete("/user/delete-users",JSON.stringify({identifiers:identifiers}),function(){console.log("Delete Users Complete.")},"json").done(async function(data){selectedButton.html("Success.");await sleep(1500);$("#modify-users").modal("hide");$(".btn-reduced").prop("disabled",false);window.location.reload()}).fail(requestFailure)})}